!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
!  This module contains a simple codes for adaptive integration.  They are used
!  almost exclusively for testing other codes.
!
!  The following subroutines are user-callable:
!
!    adaprect - adaptively compute the integral of a user-specified bivariate function 
!     on a rectangle
!
!    adapint - adaptively compute the integral of a user-specified univariate function
!      on an interval
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

module adapquad

use utils
use iso_c_binding

implicit double precision (a-h,o-z)

interface     

subroutine adapfun1d(n,xs,vals,userptr)
import c_ptr
implicit double precision (a-h,o-z)
double precision :: xs(n)
double precision :: vals(n)
type(c_ptr)      :: userptr
end subroutine



subroutine adapfun2d(n,xs,ys,vals,userptr)
import c_ptr
implicit double precision (a-h,o-z)
double precision :: xs(n),ys(n)
double precision :: vals(n)
type(c_ptr)      :: userptr
end subroutine


end interface 

contains


subroutine adapint(ier,eps,x1_0,x2_0,fun,userptr,val,ntotal)
implicit double precision (a-h,o-z)
procedure(adapfun1d)      :: fun
type(c_ptr)               :: userptr
double precision          :: eps,x1,x2
double precision          :: val

!
!  Adaptively compute the integral of a user-specified function on
!  the interval (x1,x2).
!
!  Input parameters:
!    (x1,y2) - the interval on which to evaluate the function
!    fun - the user-specified external function, which must conform to
!      the adapfun1d interface
!    userptr - a user-supplied pointer which is passed to the 
!       external function
!
!  Output parameters:
!     val - the value of the integral
!     ntotal - the number of nodes in the adaptively determined quadrature
!       rule used to evaluate the integral
!

double precision, allocatable :: stack(:,:)
double precision, allocatable :: vals(:)
double precision              :: sum1,sum2,sum0,sum00

! this is a 30 point Gauss-Legendre quadrature rule
double precision :: xs(30),whts(30)
integer          :: nquad
data nquad / 30 /
data xs  /                                     &
  -0.996893484074649540271630050918695241D+00, &
  -0.983668123279747209970032581605662842D+00, &
  -0.960021864968307512216871025581797646D+00, &
  -0.926200047429274325879324277080474015D+00, &
  -0.882560535792052681543116462530225587D+00, &
  -0.829565762382768397442898119732501916D+00, &
  -0.767777432104826194917977340974503127D+00, &
  -0.697850494793315796932292388026640086D+00, &
  -0.620526182989242861140477556431189243D+00, &
  -0.536624148142019899264169793311072772D+00, &
  -0.447033769538089176780609900322854008D+00, &
  -0.352704725530878113471037207089373868D+00, &
  -0.254636926167889846439805129817805114D+00, &
  -0.153869913608583546963794672743255924D+00, &
  -0.514718425553176958330252131667225730D-01, &
   0.514718425553176958330252131667225730D-01, &
   0.153869913608583546963794672743255924D+00, &
   0.254636926167889846439805129817805114D+00, &
   0.352704725530878113471037207089373868D+00, &
   0.447033769538089176780609900322854008D+00, &
   0.536624148142019899264169793311072772D+00, &
   0.620526182989242861140477556431189243D+00, &
   0.697850494793315796932292388026640086D+00, &
   0.767777432104826194917977340974503127D+00, &
   0.829565762382768397442898119732501916D+00, &
   0.882560535792052681543116462530225587D+00, &
   0.926200047429274325879324277080474015D+00, &
   0.960021864968307512216871025581797646D+00, &
   0.983668123279747209970032581605662842D+00, &
   0.996893484074649540271630050918695241D+00  /
data whts /                                    &
   0.796819249616660561546588347467375358D-02, &
   0.184664683110909591423021319120472140D-01, &
   0.287847078833233693497191796112920951D-01, &
   0.387991925696270495968019364463476587D-01, &
   0.484026728305940529029381404228076120D-01, &
   0.574931562176190664817216894020561829D-01, &
   0.659742298821804951281285151159623159D-01, &
   0.737559747377052062682438500221908157D-01, &
   0.807558952294202153546949384605296923D-01, &
   0.868997872010829798023875307151257485D-01, &
   0.921225222377861287176327070876187878D-01, &
   0.963687371746442596394686263518098668D-01, &
   0.995934205867952670627802821035694149D-01, &
   0.101762389748405504596428952168553985D+00, &
   0.102852652893558840341285636705414965D+00, &
   0.102852652893558840341285636705414965D+00, &
   0.101762389748405504596428952168553985D+00, &
   0.995934205867952670627802821035694149D-01, &
   0.963687371746442596394686263518098668D-01, &
   0.921225222377861287176327070876187878D-01, &
   0.868997872010829798023875307151257485D-01, &
   0.807558952294202153546949384605296923D-01, &
   0.737559747377052062682438500221908157D-01, &
   0.659742298821804951281285151159623159D-01, &
   0.574931562176190664817216894020561829D-01, &
   0.484026728305940529029381404228076120D-01, &
   0.387991925696270495968019364463476587D-01, &
   0.287847078833233693497191796112920951D-01, &
   0.184664683110909591423021319120472140D-01, &
   0.796819249616660561546588347467375358D-02  /

ier = 0


!
!  Allocate and initialize the stack
!

maxstack = 10000
allocate(stack(4,maxstack),vals(nquad))

istack          = 1
stack(1,istack) = x1_0
stack(2,istack) = x2_0

call fun(nquad,xs*(x2_0-x1_0)/2+(x2_0+x1_0)/2,vals,userptr)
sum1 = sum(vals*whts*(x2_0-x1_0)/2)
stack(3,istack) = sum1


val    = 0 
ntotal = 0

do while (istack .gt. 0)

!
!  Pop an interval off the stack
!

x1      = stack(1,istack)
x2      = stack(2,istack)
sum0    = stack(3,istack)
istack  = istack -1


!
!  Check to see if subdividing the interval yields a different result
!
x3 = (x1+x2)/2

xx1 = x1
xx2 = x3
call fun(nquad,xs*(xx2-xx1)/2+(xx2+xx1)/2,vals,userptr)
sum1 = sum(vals*whts*(xx2-xx1)/2)

xx1 = x3
xx2 = x2
call fun(nquad,xs*(xx2-xx1)/2+(xx2+xx1)/2,vals,userptr)
sum2 = sum(vals*whts*(xx2-xx1)/2)


sum00 = sum1+sum2
diff  = abs(sum0-sum00)


!
!  If not, add the contribution of the interval to the total
!


if (diff .lt. eps) then
val    = val + sum0
ntotal = ntotal + nquad
else

!
!  Otherwise, push the child intervals onto the stack
!

if (istack+2 .gt. maxstack) then
ier = 4
return
endif

istack = istack+1
stack(1,istack) = x1
stack(2,istack) = x3
stack(3,istack) = sum1

istack = istack+1
stack(1,istack) = x3
stack(2,istack) = x2
stack(3,istack) = sum2


end if

end do

end subroutine



subroutine adaprect(ier,eps,x1_0,y1_0,x2_0,y2_0,fun,userptr,val,ntotal)
implicit double precision (a-h,o-z)
procedure(adapfun2d)      :: fun
type(c_ptr)               :: userptr
double precision          :: eps,x1,y1,x2,y2
double precision          :: val

!
!  Adaptively compute the integral of a user-specified function on
!  the rectangle [x1,x2] x [y1,y2].
!
!  Input parameters:
!    (x1,y1) - the lower-left hand corner of the integration domain
!    (x2,y2) - the upper-right hand corner of the integration domain
!    fun - the user-specified external function, which must conform to
!      the adapfun2d interface
!    userptr - a user-supplied pointer which is passed to the 
!       external function
!
!  Output parameters:
!     val - the value of the integral
!     ntotal - the number of nodes in the adaptively determined quadrature
!       rule used to evaluate the integral
!

integer                       :: nquad
double precision, allocatable :: stack(:,:)
double precision, allocatable :: vals(:)
double precision              :: sum1,sum2,sum3,sum4,sum0,sum00

! this a 21st order quadrature
data nquad / 86 /
double precision              :: xs(86), ys(86), whts(86)
data xs /   0.994253635613629523722490756855000039D+00, &
           -0.858378019784901770964575830064999976D+00, &
            0.230830874131108879602515317757999999D+00, &
            0.239786701252146484651229347840000001D+00, &
            0.157464146369485416612565825778000005D+00, &
            0.456493831212257160307176991955999989D+00, &
           -0.727958767483723230439247012192999996D+00, &
           -0.721507782883110567124164947910999990D+00, &
            0.722111862091095970407004093639000041D+00, &
            0.718586377355699636984549071189000029D+00, &
           -0.174728002598389516949937444494999996D+00, &
            0.731394346980376760307320166198999966D+00, &
            0.209200435448319295951667538899000002D+00, &
           -0.561863438411777603288656572850000038D+00, &
            0.977667581634171376464244463845999952D+00, &
            0.446455165743089427296787970421999983D+00, &
            0.545592583884214670987313952457999999D+00, &
           -0.167011310492583943551623795867999989D-01, &
           -0.872984659983330288243717182040000014D+00, &
           -0.802914044086094837290035267937000021D+00, &
            0.845238117340979313764691313766999972D+00, &
            0.562425702336407908850739987708999989D+00, &
            0.981866674597085618323443861886000005D+00, &
           -0.208550827916990628447344642212000000D+00, &
            0.969063440219788252954618477365999978D+00, &
            0.706466058395122246175432407725000029D+00, &
            0.734118852299765353335727069618999980D+00, &
            0.921234122420704575963543569147000004D+00, &
            0.172169364425219597811447102699999998D-01, &
            0.992799926788995860837532104060000041D+00, &
           -0.921441776789046769209743778754000015D+00, &
            0.983555017065130597513197636095999993D+00, &
           -0.801314954454401917816183555378000014D+00, &
           -0.844568885730960521357061374774000018D+00, &
           -0.736901288689084836022328761502999989D+00, &
            0.207266361852587866570504032344999993D+00, &
           -0.716652937797976212567428865570000035D+00, &
            0.471849553038063018152903653343000014D+00, &
           -0.987146370318293923843090440996000029D+00, &
           -0.936685596108257923267997734270999957D+00, &
           -0.992805666104143220308060623585000009D+00, &
            0.987121081173077967514390528266999980D+00, &
            0.701537286831419427557692627274000003D+00, &
           -0.701560472215933180424885353082999965D+00, &
           -0.485392248885570115682559229706000001D+00, &
            0.862668371486748564287077013433000029D+00, &
            0.485350061274460793149509961308000019D+00, &
           -0.446927878634835140017196227463999989D+00, &
           -0.460638766818730163277186626734000016D-01, &
           -0.625354323121565560398203055526000029D+00, &
           -0.968810133221312799990790811015000003D+00, &
           -0.985576566739296397766938735829000045D+00, &
            0.985556547682705588830418540986999964D+00, &
            0.412392110175465741071404209153999989D+00, &
            0.177534951178386701442240575637999990D+00, &
            0.936826155739175236252639881544000035D+00, &
            0.625049080153143860769160584219999967D+00, &
            0.403505009621937819795810711865999993D-01, &
            0.398211511261701958965002686740999983D+00, &
            0.873940235960029234888505894575999991D+00, &
            0.801416361665674319111992977957999997D+00, &
           -0.176699720324209814470184095930000000D+00, &
           -0.473253040237755172444088244228000006D+00, &
           -0.981812023790591104404362036443000030D+00, &
            0.894197367492280806617678124823000025D+00, &
           -0.624940178201454474722786788623999978D+00, &
            0.802966107958518278583626301693000040D+00, &
           -0.529218418881575537417839435941999972D+00, &
           -0.978318642160091525686856446318999986D+00, &
           -0.983556917125408360852734279115999988D+00, &
           -0.397564899026338755283515161334999991D+00, &
           -0.113722103379865589826332010894999999D-01, &
            0.112850346837702728750208056939000002D-01, &
            0.928452472029966373824874638507000016D+00, &
            0.625333366330052656281878272260999977D+00, &
           -0.296022978520724030041790008179999998D+00, &
           -0.262330252245230294725397403850999976D+00, &
            0.262459688758930109379889237920999994D+00, &
           -0.895248069274114684835457135286999963D+00, &
           -0.862626896341197040740852440423999971D+00, &
            0.286248228125538199727225060791000004D+00, &
           -0.706363058412853785046030183731999963D+00, &
           -0.208565981749105876786179566109999992D+00, &
           -0.928425994313723837482064196314000003D+00, &
           -0.412392187278145311176585519870000019D+00, &
           -0.236364139049470473685836648624999997D+00  /
data ys /  -0.765131086315975529105040212913000002D+00, &
            0.127677337068314208101620841156000005D+00, &
            0.121691315442490993583334912010000007D-01, &
            0.258819164709295842630104905187999998D-01, &
           -0.723826756964348100614921056642000014D+00, &
            0.300977539633382631702340485236999992D+00, &
            0.885524067093550747535423816931999968D-01, &
           -0.146324346328918995730666900293999996D-01, &
            0.321221607093264616552570737326999987D-01, &
            0.998477846802714998502904519665999969D+00, &
            0.706867510372679588494083957602000003D+00, &
           -0.803215168637216512096078963915999974D-01, &
           -0.987989403641631383112692179511000022D+00, &
            0.353922804423102517884142382249999998D+00, &
           -0.828627384671741443722946871073999956D+00, &
           -0.200477370398046064553817022548999993D+00, &
            0.198580655605754521443002401140000008D+00, &
           -0.973118879999742486358711616414000000D+00, &
            0.316857130599429266077021567090999982D+00, &
           -0.359085918774103012600365353017000022D+00, &
            0.965837515721991842801235258679000021D+00, &
           -0.352425220979311110397419137098000017D+00, &
            0.981756706090433843819945007830999969D+00, &
            0.988050225539410584506410629435999996D+00, &
           -0.540126836382894555734614359051999998D+00, &
           -0.533986520592259664474722084267000045D+00, &
           -0.994363188727357491628345645666000045D+00, &
            0.929029220920176973890045292218999946D-01, &
            0.973006456127090912847520545544000028D+00, &
            0.765262810061598410246703746240999986D+00, &
           -0.934287433319927492163052690899000010D-01, &
           -0.984658776835206290475849516670999973D+00, &
           -0.770120038642867627571110820722000048D+00, &
           -0.966090009707500034592443899021000005D+00, &
            0.994183199256730151535296796035999977D+00, &
           -0.853100524495149385531903473897999960D+00, &
           -0.998783365425796743319188773366000023D+00, &
           -0.951856016670131565136984461366999965D+00, &
           -0.339970643426490344101740712652999989D+00, &
           -0.890460677765048621178689187263000005D+00, &
           -0.765275504417930956823501230152000044D+00, &
            0.339753079575245584275955104732000019D+00, &
           -0.864382967222633957173323133766999966D+00, &
            0.864433755574825597227777996060999955D+00, &
            0.717859452901110864234815639035000030D+00, &
           -0.715563704401985470876871670874000036D+00, &
           -0.717668026630579868906548603571999953D+00, &
            0.200803195868041736361855506428000010D+00, &
           -0.670526077411590178258357923797999984D+00, &
           -0.907571675952845789779185423323000026D+00, &
            0.539152130471714245871032242282000002D+00, &
            0.163078615094804992850811830562000003D+00, &
           -0.163068938543867800013969633578000002D+00, &
            0.766190523164844844569829678496999986D+00, &
            0.893455284070150120024058045585999983D+00, &
            0.890465822783077759510176483687000045D+00, &
            0.580804494330941729636946979659999960D+00, &
            0.674830997206047941665948993135999995D+00, &
            0.978894833543799593750160137861000001D+00, &
           -0.318052008368220192895526725296999991D+00, &
            0.770207380158406598172271728311000024D+00, &
           -0.893220026184542370408311703683999957D+00, &
            0.952378947698840667152227342522000014D+00, &
           -0.981688443336781562545881566151999989D+00, &
           -0.940404878127581014828919795200000009D+00, &
           -0.580706299868352201308409230658000031D+00, &
            0.359213584391817937097181302972000013D+00, &
           -0.218038084272336322252229718094000009D+00, &
            0.826747322748235839879827385234999988D+00, &
            0.984626422725976451030232342952999965D+00, &
           -0.978743104038513339120614140137000039D+00, &
            0.268078167243461753143974255881999980D+00, &
           -0.268176069161810597001325036008000009D+00, &
            0.585411087047308169117704826411999998D+00, &
            0.907546757994688242985190815950000009D+00, &
           -0.459964439902724334827113806867000009D+00, &
            0.501171096844175282429922646671000040D+00, &
           -0.501519646284647842553092637876999995D+00, &
            0.939623308387558900204666812478000000D+00, &
            0.715514282733998355840875525815000032D+00, &
            0.468961477128179093628432956022999990D+00, &
            0.534073278311740385979383800191999966D+00, &
            0.853463583294765802370242859162000042D+00, &
           -0.585404528536861334787133927613000012D+00, &
           -0.766261838410062534262504209054999992D+00, &
           -0.203781862975735664963153930889999997D-01  /
data whts /   0.185558333401977924017735378888999990D-03, &
            0.103285911376111985411925837600999992D-02, &
            0.482405214556444039450261334745000001D-01, &
            0.751438538505261679769143811242000041D-01, &
            0.974242034382739187797996126688999971D-02, &
            0.310612773919082808003926620605000002D-01, &
            0.572616787566728883988086122706999973D-01, &
            0.391981166728547183023185866466000024D-01, &
            0.250922203337891824741663723240999998D-01, &
            0.484512704268936695914312822971999984D-02, &
            0.792704350828089168956355993273000019D-02, &
            0.692719149247962689267232724903000015D-01, &
            0.108312264883867632094124058275999993D-01, &
            0.560612667501584028021047627523999990D-01, &
            0.134944782007200241999354168667999993D-01, &
            0.846399031768508982370546305981000060D-01, &
            0.897132400644697738271806683220999987D-01, &
            0.192548383282855758252145614636999985D-01, &
            0.603091002742962495033088372758000008D-01, &
            0.734554991363626150441967361531999959D-01, &
            0.131773787871599100060721394590999994D-01, &
            0.565767535504727655385757887346000002D-01, &
            0.331813832915788686287497089100999991D-02, &
            0.108381014037468986977410000330000002D-01, &
            0.257573045131887848633002949877000000D-01, &
            0.724299477389102137610622009202999972D-01, &
            0.909745218642153874110415540896999945D-02, &
            0.497946584425209722544483653082000023D-01, &
            0.192775610855914232268063692375999985D-01, &
            0.851902572045121293390417744407000013D-02, &
            0.495890651880218684552999068406000003D-01, &
            0.285060151593659206095584611987000003D-02, &
            0.501360738292129801127337564901000021D-01, &
            0.132371320981992882015441067316999997D-01, &
            0.913034677910557149988578191544999952D-02, &
            0.656442609137016126120701623923999961D-01, &
            0.476089622127517947332391521065000027D-02, &
            0.343510494894014107474015308071999997D-01, &
            0.168056495338962334089447731494999991D-01, &
            0.176124704885583593920360447352999988D-01, &
            0.852115813287725134185142610112000045D-02, &
            0.168372939018130638095539866483999991D-01, &
            0.463229444080503234423676485120999984D-01, &
            0.463112649923948147973306123794999994D-01, &
            0.804244680153394887532272943430000027D-01, &
            0.450004958627840045366793622740000017D-01, &
            0.805050876565781053517014697665999959D-01, &
            0.848713919512639664656136242805000002D-01, &
            0.958918437344523499311150495963999957D-01, &
            0.426375767740457204814991169764999995D-01, &
            0.259802267198022035359799263728999988D-01, &
            0.185508952722154700356746488808999989D-01, &
            0.185666335167950701746720574443000004D-01, &
            0.751577015075917453033482001154999944D-01, &
            0.499018600497252701300501446131999976D-01, &
            0.175630868763466619089286338359000004D-01, &
            0.832405052694291623026875652386000000D-01, &
            0.952718729904638322629736058359999962D-01, &
            0.210639479041886533151916221717000002D-01, &
            0.601666320427107802818736370054000004D-01, &
            0.501257697360878857458247572703000005D-01, &
            0.500055488947868537298643940612000011D-01, &
            0.341492800042380155517262444802999984D-01, &
            0.333021395808946028623337452387999999D-02, &
            0.193359889435346446048582396713000004D-01, &
            0.832632520386129908161381403077000023D-01, &
            0.733917979122901932167649923151999963D-01, &
            0.109916357554934078317851661217000003D+00, &
            0.135165656196906438267745008128000005D-01, &
            0.285317599994189240438509773207000017D-02, &
            0.211507321013708535646042292125000008D-01, &
            0.126915370850378634378219951296999991D+00, &
            0.126907529253996084657113859705000009D+00, &
            0.396522225543684461844398543875000028D-01, &
            0.426444657073300157010047241798000012D-01, &
            0.113394551562528184442327174901999999D+00, &
            0.108662318559698173080763967231999994D+00, &
            0.109055939921291945467136824846999996D+00, &
            0.193758037029047190205262733924999986D-01, &
            0.450119623280731757946222150382999985D-01, &
            0.108176500909127536465216932171000001D+00, &
            0.723803742742923875616657962649999950D-01, &
            0.662380220659105673756901738693000016D-01, &
            0.396633132807455872565479673605999984D-01, &
            0.751632758353011397333863331442999971D-01, &
            0.123266766888994288026325718560000002D+00  /


ier = 0


!
!  Allocate and initialize the stack
!


maxstack = 10000
allocate(stack(6,maxstack),vals(nquad))

istack          = 1
stack(1,istack) = x1_0
stack(2,istack) = y1_0
stack(3,istack) = x2_0
stack(4,istack) = y2_0

call fun(nquad,xs*(x2_0-x1_0)/2+(x2_0+x1_0)/2,ys*(y2_0-y1_0)/2+(y2_0+y1_0)/2,vals,userptr)
sum1 = sum(vals*whts*(x2_0-x1_0)/2*(y2_0-y1_0)/2)

stack(5,istack) = sum1


val    = 0 
ntotal = 0

do while (istack .gt. 0)

!
!  Pop a rectangle off the stack
!

x1      = stack(1,istack)
y1      = stack(2,istack)
x2      = stack(3,istack)
y2      = stack(4,istack)
sum0    = stack(5,istack)
istack  = istack -1



!
!  Check to see if subdividing the rectangle yields a different
!  result
!

x3 = (x1+x2)/2
y3 = (y1+y2)/2

xx1 = x1
yy1 = y1
xx2 = x3
yy2 = y3
call fun(nquad,xs*(xx2-xx1)/2+(xx2+xx1)/2,ys*(yy2-yy1)/2+(yy1+yy2)/2,vals,userptr)
sum1 = sum(vals*whts*(xx2-xx1)/2*(yy2-yy1)/2)

xx1 = x3
yy1 = y1
xx2 = x2
yy2 = y3
call fun(nquad,xs*(xx2-xx1)/2+(xx2+xx1)/2,ys*(yy2-yy1)/2+(yy1+yy2)/2,vals,userptr)
sum2 = sum(vals*whts*(xx2-xx1)/2*(yy2-yy1)/2)

xx1 = x3
yy1 = y3
xx2 = x2
yy2 = y2
call fun(nquad,xs*(xx2-xx1)/2+(xx2+xx1)/2,ys*(yy2-yy1)/2+(yy1+yy2)/2,vals,userptr)
sum3 = sum(vals*whts*(xx2-xx1)/2*(yy2-yy1)/2)

xx1 = x1
yy1 = y3
xx2 = x3
yy2 = y2
call fun(nquad,xs*(xx2-xx1)/2+(xx2+xx1)/2,ys*(yy2-yy1)/2+(yy1+yy2)/2,vals,userptr)
sum4 = sum(vals*whts*(xx2-xx1)/2*(yy2-yy1)/2)

sum00 = sum1+sum2+sum3+sum4
diff  = abs(sum0-sum00)


!
!  If not, add the contribution of the rectangle to the total
!


if (diff .lt. eps) then
val    = val + sum0
ntotal = ntotal + nquad
else

!
!  Otherwise, push the child rectangles onto the stack
!

if (istack+4 .gt. maxstack) then
ier = 4
return
endif

istack = istack+1
stack(1,istack) = x1
stack(2,istack) = y1
stack(3,istack) = x3
stack(4,istack) = y3
stack(5,istack) = sum1

istack = istack+1
stack(1,istack) = x3
stack(2,istack) = y1
stack(3,istack) = x2
stack(4,istack) = y3
stack(5,istack) = sum2

istack = istack+1
stack(1,istack) = x3
stack(2,istack) = y3
stack(3,istack) = x2
stack(4,istack) = y2
stack(5,istack) = sum3

istack = istack+1
stack(1,istack) = x1
stack(2,istack) = y3
stack(3,istack) = x3
stack(4,istack) = y2
stack(5,istack) = sum4

end if

end do

end subroutine

end module
